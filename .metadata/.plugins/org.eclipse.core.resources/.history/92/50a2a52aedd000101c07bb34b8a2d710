package com.yanzhengma.demo.service.impl;

import com.baomidou.mybatisplus.core.conditions.query.LambdaQueryWrapper;
import com.baomidou.mybatisplus.extension.service.impl.ServiceImpl;
import com.yanzhengma.demo.dto.RegisterDTO;
import com.yanzhengma.demo.entity.User;
import com.yanzhengma.demo.mapper.UserMapper;
import com.yanzhengma.demo.service.UserService;
import com.yanzhengma.demo.utils.RedisUtil;
import org.springframework.beans.factory.annotation.Autowired;
//import org.springframework.security.crypto.bcrypt.BCryptPasswordEncoder;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;
import org.springframework.util.StringUtils;

@Service
public class UserServiceImpl extends ServiceImpl<UserMapper, User> implements UserService {

    @Autowired
    private RedisUtil redisUtil;

    @Override
    @Transactional
    public void register(RegisterDTO dto) {
        // 1. 验证码校验
        String redisCaptcha = (String) redisUtil.get(dto.getUuid());
        if (!StringUtils.hasText(redisCaptcha) || !redisCaptcha.equalsIgnoreCase(dto.getCaptcha())) {
            throw new RuntimeException("验证码错误或已过期");
        }

        // 2. 检查用户名是否已存在
        if (this.count(new LambdaQueryWrapper<User>().eq(User::getUserName, dto.getUserName())) > 0) {
            throw new RuntimeException("用户名已存在");
        }

        // 3. 密码加密
//        BCryptPasswordEncoder encoder = new BCryptPasswordEncoder();
//        String encodedPassword = encoder.encode(dto.getPassword());
        String encodedPassword = passwordEncoder.encode(dto.getPassword());

        // 4. 构建用户实体
        User user = new User();
        user.setUserId(dto.getUserId());
        user.setUserName(dto.getUserName());
        user.setPassword(encodedPassword);
        user.setGender(dto.getGender());
        user.setPhone(dto.getPhone());
        user.setEmail(dto.getEmail());
        String currentUserId = dto.getUserId(); // 注册人就是自己
        user.setCreatedBy(currentUserId);
        user.setUpdatedBy(currentUserId); // 初始更新者也是自己

        // 5. 保存到数据库
        this.save(user);

        // 6. 删除已使用的验证码（防止重用）
        redisUtil.delete(dto.getUuid());
    }
}