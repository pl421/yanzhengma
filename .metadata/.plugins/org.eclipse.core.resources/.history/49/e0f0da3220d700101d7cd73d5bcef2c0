package com.yanzhengma.demo.controller;

import com.baomidou.mybatisplus.core.conditions.query.QueryWrapper;
import com.yanzhengma.demo.dto.LoginRequest;
import com.yanzhengma.demo.dto.RegisterDTO;
import com.yanzhengma.demo.entity.User;
import com.yanzhengma.demo.mapper.UserMapper;
import com.yanzhengma.demo.service.UserService;
import com.yanzhengma.demo.service.impl.EmailService;
import com.yanzhengma.demo.utils.PasswordResetTokenUtil;

import java.util.Map;

import javax.validation.Valid;

//import jakarta.validation.Valid;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.http.ResponseEntity;
import org.springframework.security.authentication.AuthenticationManager;
import org.springframework.security.authentication.BadCredentialsException;
import org.springframework.security.authentication.UsernamePasswordAuthenticationToken;
import org.springframework.security.core.Authentication;
import org.springframework.security.crypto.password.PasswordEncoder;
import org.springframework.web.bind.annotation.CrossOrigin;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestBody;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RestController;

@RestController
@RequestMapping("/api/auth")
//@CrossOrigin(origins = "http://localhost:5173") 
public class AuthController {

    @Autowired
    private UserService userService;
    @Autowired
    private AuthenticationManager authenticationManager;
    
    @Autowired
    private UserMapper userMapper;

    @Autowired
    private EmailService emailService;

    @Autowired
    private PasswordResetTokenUtil tokenUtil;

    @Autowired
    private PasswordEncoder passwordEncoder;

    @PostMapping("/register")
    public String register(@Valid @RequestBody RegisterDTO dto) {
        userService.register(dto);
        return "注册成功";
    }
    
    @PostMapping("/login")
    public String login(@RequestBody LoginRequest request) {
        try {
            // 验证用户名密码（触发 Spring Security 的认证流程）
            Authentication auth = authenticationManager.authenticate(
                new UsernamePasswordAuthenticationToken(request.getUserName(), request.getPassword())
            );

            // 生成 JWT
//            String token = JwtUtil.generateToken(auth.getName());
//            
//            return ResponseEntity.ok(Map.of(
//                "success", true,
//                "token", token,
//                "message", "登录成功"
//            ));
        	return "123";
        } catch (BadCredentialsException e) {
//            return ResponseEntity.status(401).body(Map.of(
//                "success", false,
//                "message", "用户名或密码错误"
//            ));
        	return "456";
        }
    }
 // Step 1: 检查用户名是否存在
    @PostMapping("/forgot-password/step1")
    public ResponseEntity<?> checkUsername(@RequestBody Map<String, String> request) {
        String username = request.get("username");
        User user = userMapper.selectOne(
            new QueryWrapper<User>()
                .eq("user_name", username)
        );
        if (user == null) {
            return ResponseEntity.badRequest().body(Map.of("error", "用户名不存在"));
        }
        return ResponseEntity.ok(Map.of("message", "success"));
    }

    // Step 2: 验证邮箱并发送邮件
    @PostMapping("/forgot-password/step2")
    public ResponseEntity<?> sendResetEmail(@RequestBody Map<String, String> request) {
        String username = request.get("username");
        String email = request.get("email");

        User user = userMapper.selectOne(
        	    new QueryWrapper<User>()
                .eq("username", username)
                .eq("email", email)
        );
        if (user == null) {
            return ResponseEntity.badRequest().body(Map.of("error", "邮箱与用户名不匹配"));
        }

        String token = tokenUtil.generateToken(user.getEmail());
        String resetUrl = "http://localhost:8080/reset-password?token=" + token;

        emailService.sendPasswordResetEmail(user.getEmail(), user.getUserName(), resetUrl);

        return ResponseEntity.ok(Map.of("message", "重置链接已发送至您的邮箱"));
    }

    // 重置密码
    @PostMapping("/reset-password")
    public ResponseEntity<?> resetPassword(@RequestBody Map<String, String> request) {
        String token = request.get("token");
        String newPassword = request.get("newPassword");

        if (token == null || newPassword == null || newPassword.length() < 6) {
            return ResponseEntity.badRequest().body(Map.of("error", "参数无效"));
        }

        String email = tokenUtil.getEmailFromToken(token);
        if (email == null || tokenUtil.isTokenExpired(token)) {
            return ResponseEntity.badRequest().body(Map.of("error", "无效或已过期的重置链接"));
        }

        User user = userMapper.selectOne(
        	    new QueryWrapper<User>()
        	        .eq("email", email)
        	);
        if (user == null) {
            return ResponseEntity.badRequest().body(Map.of("error", "用户不存在"));
        }

        user.setPassword(passwordEncoder.encode(newPassword));
        userMapper.updateById(user);

        return ResponseEntity.ok(Map.of("message", "密码重置成功"));
    }
}